name: Deploy to STRATO via SFTP

on:
  push:
    branches: [ "main" ]

concurrency:
  group: deploy-strato
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Optional: falls ihr mal build steps hattet â€“ aktuell statisch, daher nur Copy.
      - name: Prepare deploy folder
        shell: bash
        run: |
          set -euo pipefail
          rm -rf deploy
          mkdir -p deploy

          # Alles ins deploy/ kopieren, aber .git/.github nie deployen
          rsync -a \
            --exclude=".git" \
            --exclude=".github" \
            --exclude="deploy" \
            ./ deploy/

          echo "Prepared deploy folder:"
          ls -la deploy | head -n 200

      - name: Validate required secrets
        shell: bash
        env:
          SFTP_SERVER: ${{ secrets.STRATO_SFTP_SERVER }}
          SFTP_USERNAME: ${{ secrets.STRATO_SFTP_USERNAME }}
          SFTP_PASSWORD: ${{ secrets.STRATO_SFTP_PASSWORD }}
          SFTP_REMOTE_PATH: ${{ secrets.STRATO_SFTP_REMOTE_PATH }}
        run: |
          set -euo pipefail

          if [[ -z "${SFTP_SERVER:-}" ]]; then echo "Missing secret: STRATO_SFTP_SERVER" >&2; exit 1; fi
          if [[ -z "${SFTP_USERNAME:-}" ]]; then echo "Missing secret: STRATO_SFTP_USERNAME" >&2; exit 1; fi
          if [[ -z "${SFTP_PASSWORD:-}" ]]; then echo "Missing secret: STRATO_SFTP_PASSWORD" >&2; exit 1; fi
          if [[ -z "${SFTP_REMOTE_PATH:-}" ]]; then
            echo "Missing/empty secret: STRATO_SFTP_REMOTE_PATH (this is the cause of 'remote_path is empty')" >&2
            exit 1
          fi

          echo "Secrets look non-empty. Remote path set to: '${SFTP_REMOTE_PATH}'"

      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Probe remote and deploy
        shell: bash
        env:
          SFTP_SERVER: ${{ secrets.STRATO_SFTP_SERVER }}
          SFTP_USERNAME: ${{ secrets.STRATO_SFTP_USERNAME }}
          SFTP_PASSWORD: ${{ secrets.STRATO_SFTP_PASSWORD }}
          SFTP_REMOTE_PATH: ${{ secrets.STRATO_SFTP_REMOTE_PATH }}
        run: |
          set -euo pipefail

          echo "Connecting to ${SFTP_SERVER} ..."
          lftp -u "${SFTP_USERNAME}","${SFTP_PASSWORD}" "sftp://${SFTP_SERVER}" <<LFTP
          set sftp:auto-confirm yes
          set net:max-retries 2
          set net:timeout 20
          set cmd:fail-exit yes

          echo "=== Remote PWD / LS (before) ==="
          pwd
          ls -la

          echo "=== Ensure remote path exists ==="
          mkdir -p "${SFTP_REMOTE_PATH}"
          cd "${SFTP_REMOTE_PATH}"
          pwd
          ls -la

          echo "=== Upload deploy/ -> remote ==="
          mirror -R \
            --verbose \
            --only-newer \
            --parallel=2 \
            --exclude-glob .git/ \
            --exclude-glob .github/ \
            deploy/ .

          echo "=== Remote LS (after) ==="
          ls -la

          bye
LFTP
