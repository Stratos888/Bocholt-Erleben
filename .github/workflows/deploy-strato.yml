name: Deploy to STRATO via SFTP

on:
  push:
    branches: [ "main" ]

concurrency:
  group: deploy-strato
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare deploy folder
        shell: bash
        run: |
          set -e
          rm -rf deploy
          mkdir -p deploy
          rsync -a --exclude=".git" --exclude=".github" --exclude="deploy" ./ deploy/

      - name: Validate required secrets
        shell: bash
        run: |
          test -n "${{ secrets.STRATO_FTP_SERVER }}" || (echo "Missing STRATO_FTP_SERVER" && exit 1)
          test -n "${{ secrets.STRATO_FTP_USERNAME }}" || (echo "Missing STRATO_FTP_USERNAME" && exit 1)
          test -n "${{ secrets.STRATO_FTP_PASSWORD }}" || (echo "Missing STRATO_FTP_PASSWORD" && exit 1)
          test -n "${{ secrets.STRATO_FTP_REMOTE_PATH }}" || (echo "Missing STRATO_FTP_REMOTE_PATH" && exit 1)

      - name: Install lftp + ssh client
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp openssh-client

      - name: Debug remote path (SFTP)
        shell: bash
        env:
          STRATO_FTP_SERVER: ${{ secrets.STRATO_FTP_SERVER }}
          STRATO_FTP_USERNAME: ${{ secrets.STRATO_FTP_USERNAME }}
          STRATO_FTP_PASSWORD: ${{ secrets.STRATO_FTP_PASSWORD }}
          STRATO_FTP_REMOTE_PATH: ${{ secrets.STRATO_FTP_REMOTE_PATH }}
        run: |
          set -euo pipefail
          echo "REMOTE_PATH length: ${#STRATO_FTP_REMOTE_PATH}"
          echo "REMOTE_PATH endswith '/': $([[ "${STRATO_FTP_REMOTE_PATH}" == */ ]] && echo yes || echo no)"
          echo "REMOTE_PATH startswith '/': $([[ "${STRATO_FTP_REMOTE_PATH}" == /* ]] && echo yes || echo no)"

          # Ensure ssh exists where we expect it (GitHub runners sometimes have it under /usr/bin or /bin)
          SSH_BIN="$(command -v ssh || true)"
          if [ -z "$SSH_BIN" ]; then
            echo "ssh not found even after installing openssh-client"
            exit 1
          fi
          echo "Using SSH_BIN=$SSH_BIN"

          lftp -u "${STRATO_FTP_USERNAME}","${STRATO_FTP_PASSWORD}" "sftp://${STRATO_FTP_SERVER}" -e "
            set cmd:fail-exit yes;
            set net:max-retries 1;
            set net:reconnect-interval-base 2;

            set sftp:auto-confirm yes;
            set sftp:connect-program \"$SSH_BIN -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null\";

            echo '--- SERVER ROOT (pwd/ls) ---';
            pwd;
            cls -la;

            echo '--- TRY cd to REMOTE_PATH ---';
            cd \"${STRATO_FTP_REMOTE_PATH}\";
            pwd;
            cls -la;

            echo '--- CHECK entries css/data/js (type hints) ---';
            cls -la css || true;
            cls -la data || true;
            cls -la js || true;

            bye;
          "

      - name: Deploy via SFTP
        shell: bash
        env:
          STRATO_FTP_SERVER: ${{ secrets.STRATO_FTP_SERVER }}
          STRATO_FTP_USERNAME: ${{ secrets.STRATO_FTP_USERNAME }}
          STRATO_FTP_PASSWORD: ${{ secrets.STRATO_FTP_PASSWORD }}
        run: |
          set -e

          SSH_BIN="$(command -v ssh || true)"
          if [ -z "$SSH_BIN" ]; then
            echo "ssh not found even after installing openssh-client"
            exit 1
          fi
          echo "Using SSH_BIN=$SSH_BIN"

          lftp -u "$STRATO_FTP_USERNAME","$STRATO_FTP_PASSWORD" \
            "sftp://$STRATO_FTP_SERVER" \
            -e "
              set cmd:fail-exit yes;
              set sftp:auto-confirm yes;
              set sftp:connect-program \"$SSH_BIN -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null\";

              pwd;
              mirror -R --verbose --only-newer deploy/ .;

              bye;
            "
