<!-- === BEGIN BLOCK: INBOX REVIEW PAGE (standalone, writeback-ready) ===
Zweck:
- Private Inbox-Review-Seite (nicht verlinkt)
- Lädt /data/inbox.json, filtert status=review
- Öffnen (url/source_url) + Übernehmen/Verwerfen per Apps-Script-Writeback
Umfang:
- Komplettes inbox/index.html inkl. Inline-JS
=== END BLOCK: INBOX REVIEW PAGE (standalone, writeback-ready) === -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inbox Review</title>
  <link rel="stylesheet" href="../css/style.css" />
  <style>
    /* minimal layout only (keine Design-Refactors) */
    .inbox-wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .inbox-top { display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .inbox-actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .inbox-list { display:flex; flex-direction:column; gap:10px; margin-top:14px; }
    .inbox-card { border: 1px solid rgba(0,0,0,.12); border-radius: 12px; padding: 12px; background: rgba(255,255,255,.02); }
    .inbox-card h3 { margin: 0 0 6px 0; font-size: 16px; line-height: 1.2; }
    .inbox-meta { font-size: 13px; opacity: .85; display:flex; flex-wrap:wrap; gap:8px; margin: 6px 0 10px; }
    .inbox-desc { font-size: 14px; opacity: .92; margin: 0 0 10px; white-space: pre-wrap; }
    .btn { padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(0,0,0,.18); background: transparent; cursor: pointer; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .btn-primary { border-color: rgba(0,0,0,.28); }
    .btn-good { border-color: rgba(0,120,0,.45); }
    .btn-bad { border-color: rgba(160,0,0,.45); }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(0,0,0,.18); font-size: 12px; }
    .muted { opacity: .75; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input[type="text"], input[type="password"] { padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(0,0,0,.18); background: transparent; }
  </style>
</head>
<body>
  <main class="inbox-wrap">
    <div class="inbox-top">
      <div>
        <div class="row">
          <strong>Inbox Review</strong>
          <span id="lockState" class="pill muted">gesperrt</span>
        </div>
        <div class="muted" style="margin-top:4px;">
          Zeigt <code>status=review</code>. Approve setzt <code>übernehmen</code>, Reject setzt <code>verworfen</code>.
        </div>
      </div>

      <div class="inbox-actions">
        <input id="apiUrl" type="text" placeholder="Apps Script /exec URL" style="min-width: 280px;" />
        <button id="saveApiUrl" class="btn btn-primary">URL speichern</button>
        <button id="unlockBtn" class="btn btn-primary">Entsperren</button>
        <button id="reloadBtn" class="btn">Reload</button>
      </div>
    </div>

    <div id="statusLine" class="muted" style="margin-top:10px;"></div>

    <section class="inbox-list" id="list"></section>
  </main>

  <script>
    // === BEGIN BLOCK: INBOX REVIEW LOGIC (JSON feed + writeback via JSONP/IMG) ===
    // Zweck:
    // - Lädt /data/inbox.json, filtert status=review
    // - Unlock via Apps Script (JSONP callback) -> token in sessionStorage
    // - setStatus via IMG GET (CORS-frei), benötigt row_number
    // Umfang:
    // - Komplettes Inline-Script für inbox/index.html
    // === END BLOCK: INBOX REVIEW LOGIC (JSON feed + writeback via JSONP/IMG) ===

    const FEED_URL = "/data/inbox.json";
    const LS_API_URL_KEY = "inbox_writeback_api_url";
    const SS_TOKEN_KEY = "inbox_writeback_token";

    const elList = document.getElementById("list");
    const elStatus = document.getElementById("statusLine");
    const elLock = document.getElementById("lockState");
    const elApiUrl = document.getElementById("apiUrl");

    document.getElementById("saveApiUrl").addEventListener("click", () => {
      const v = (elApiUrl.value || "").trim();
      if (!v) return setStatus("Bitte Apps Script /exec URL eintragen.");
      localStorage.setItem(LS_API_URL_KEY, v);
      setStatus("URL gespeichert.");
    });

    document.getElementById("reloadBtn").addEventListener("click", () => loadAndRender());

    document.getElementById("unlockBtn").addEventListener("click", async () => {
      const api = getApiUrl();
      if (!api) return setStatus("Fehlt: Apps Script /exec URL (oben eintragen + speichern).");
      const pw = prompt("Passwort zum Entsperren:");
      if (!pw) return;

      try {
        const res = await jsonp(api, { action: "unlock", password: pw });
        if (!res || !res.ok || !res.token) {
          setStatus("Unlock fehlgeschlagen.");
          return;
        }
        sessionStorage.setItem(SS_TOKEN_KEY, res.token);
        refreshLockState();
        setStatus(`Entsperrt (TTL: ${res.expires_in_seconds || "?"}s).`);
      } catch (e) {
        console.error(e);
        setStatus("Unlock fehlgeschlagen (JSONP/CORS).");
      }
    });

    function getApiUrl() {
      return (localStorage.getItem(LS_API_URL_KEY) || "").trim();
    }

    function getToken() {
      return (sessionStorage.getItem(SS_TOKEN_KEY) || "").trim();
    }

    function refreshLockState() {
      const t = getToken();
      if (t) {
        elLock.textContent = "entsperrt";
        elLock.classList.remove("muted");
      } else {
        elLock.textContent = "gesperrt";
        elLock.classList.add("muted");
      }
    }

    function setStatus(msg) {
      elStatus.textContent = msg || "";
    }

    async function loadAndRender() {
      setStatus("Lade inbox.json …");
      elList.innerHTML = "";

      const url = FEED_URL + "?v=" + Date.now();
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) {
        setStatus(`Fehler: inbox.json nicht ladbar (${r.status}).`);
        return;
      }

      const items = await r.json();
      const review = (items || []).filter(it => (String(it.status || "").toLowerCase() === "review"));

      setStatus(`Geladen: ${review.length} review-items (von ${items.length}).`);

      if (!review.length) {
        elList.innerHTML = `<div class="muted">Keine review-items vorhanden.</div>`;
        return;
      }

      for (const it of review) {
        elList.appendChild(renderCard(it));
      }
    }

    function openUrl(it) {
      const u = (it.url || it.source_url || "").trim();
      if (!u) {
        alert("Keine URL vorhanden (weder url noch source_url).");
        return;
      }
      window.open(u, "_blank", "noopener,noreferrer");
    }

    function setStatusWriteback(it, newStatus) {
      const api = getApiUrl();
      const token = getToken();

      if (!api) {
        alert("Fehlt: Apps Script /exec URL (oben eintragen + speichern).");
        return;
      }
      if (!token) {
        alert("Bitte zuerst entsperren (Button 'Entsperren').");
        return;
      }
      if (!it.row_number) {
        alert("Fehlt: row_number im Feed. Bitte Deploy prüfen.");
        return;
      }

      // CORS-frei via IMG GET (Apps Script doGet)
      // Hinweis: Das setzt voraus, dass Apps Script JSONP/GET unterstützt (siehe Code.gs Patch).
      const img = new Image();
      const qs = new URLSearchParams({
        action: "setStatus",
        token,
        row_number: String(it.row_number),
        status: String(newStatus)
      });
      img.onload = () => setStatus(`OK: row ${it.row_number} → ${newStatus}`);
      img.onerror = () => setStatus(`Fehler: row ${it.row_number} → ${newStatus} (Network/Token?)`);
      img.src = api.replace(/\/exec.*$/, "/exec") + "?" + qs.toString() + "&t=" + Date.now();

      // Optimistisch aus UI entfernen
      const card = document.getElementById("card-" + it.row_number);
      if (card) card.remove();
    }

    function renderCard(it) {
      const card = document.createElement("div");
      card.className = "inbox-card";
      card.id = "card-" + (it.row_number || Math.random().toString(16).slice(2));

      const title = escapeHtml(it.title || "(ohne Titel)");
      const meta = [];

      if (it.row_number) meta.push(`<span class="pill">row ${escapeHtml(String(it.row_number))}</span>`);
      if (it.date) meta.push(`<span class="pill">${escapeHtml(it.date)}</span>`);
      if (it.time) meta.push(`<span class="pill">${escapeHtml(it.time)}</span>`);
      if (it.city) meta.push(`<span class="pill">${escapeHtml(it.city)}</span>`);
      if (it.location) meta.push(`<span class="pill">${escapeHtml(it.location)}</span>`);
      if (it.kategorie_suggestion) meta.push(`<span class="pill">${escapeHtml(it.kategorie_suggestion)}</span>`);
      if (it.match_score) meta.push(`<span class="pill">match ${escapeHtml(it.match_score)}</span>`);
      if (it.source_name) meta.push(`<span class="pill">${escapeHtml(it.source_name)}</span>`);

      const desc = (it.description || "").trim();
      const descHtml = desc ? `<p class="inbox-desc">${escapeHtml(desc)}</p>` : "";

      card.innerHTML = `
        <h3>${title}</h3>
        <div class="inbox-meta">${meta.join("")}</div>
        ${descHtml}
        <div class="row">
          <button class="btn btn-primary" type="button">Öffnen</button>
          <button class="btn btn-good" type="button">Übernehmen</button>
          <button class="btn btn-bad" type="button">Verwerfen</button>
        </div>
      `;

      const [btnOpen, btnOk, btnNo] = card.querySelectorAll("button");
      btnOpen.addEventListener("click", () => openUrl(it));
      btnOk.addEventListener("click", () => setStatusWriteback(it, "übernehmen"));
      btnNo.addEventListener("click", () => setStatusWriteback(it, "verworfen"));

      return card;
    }

    function escapeHtml(s) {
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // JSONP helper: benötigt Apps Script Support für ?callback=fn
    function jsonp(apiUrl, params) {
      return new Promise((resolve, reject) => {
        const cbName = "__inbox_cb_" + Math.random().toString(16).slice(2);
        const qs = new URLSearchParams(params || {});
        qs.set("callback", cbName);

        const src = apiUrl.replace(/\/exec.*$/, "/exec") + "?" + qs.toString() + "&t=" + Date.now();
        const script = document.createElement("script");

        window[cbName] = (data) => {
          cleanup();
          resolve(data);
        };

        script.onerror = () => {
          cleanup();
          reject(new Error("jsonp_load_failed"));
        };

        function cleanup() {
          try { delete window[cbName]; } catch (_) { window[cbName] = undefined; }
          if (script.parentNode) script.parentNode.removeChild(script);
        }

        script.src = src;
        document.body.appendChild(script);
      });
    }

    // Init
    (function init() {
      const saved = localStorage.getItem(LS_API_URL_KEY);
      if (saved) elApiUrl.value = saved;
      refreshLockState();
      loadAndRender().catch(err => {
        console.error(err);
        setStatus("Fehler beim Laden/Rendern (siehe Console).");
      });
    })();
  </script>
</body>
</html>
