<!-- === BEGIN BLOCK: INBOX REVIEW PAGE (standalone, writeback-ready) ===
Zweck:
- Private Inbox-Review-Seite (nicht verlinkt)
- L√§dt /data/inbox.json, filtert status=review
- √ñffnen (url/source_url) + √úbernehmen/Verwerfen per Apps-Script-Writeback
Umfang:
- Komplettes inbox/index.html inkl. Inline-JS
=== END BLOCK: INBOX REVIEW PAGE (standalone, writeback-ready) === -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inbox Review</title>
  <link rel="stylesheet" href="../css/style.css" />
<style>
  /* === BEGIN BLOCK: INBOX ONE-BY-ONE UI (mobile-first, minimal) ===
     Zweck:
     - One-by-one Review (nur 1 Item sichtbar)
     - Buttons gro√ü, klare Struktur, weniger Text
     Umfang:
     - Ersetzt ausschlie√ülich den kompletten <style> Block
  === END BLOCK: INBOX ONE-BY-ONE UI (mobile-first, minimal) === */

  .inbox-wrap { max-width: 720px; margin: 0 auto; padding: 14px; }
  .inbox-top { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
  .inbox-actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

  .btn { padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(0,0,0,.18); background: transparent; cursor: pointer; }
  .btn:disabled { opacity: .45; cursor: not-allowed; }
  .btn-primary { border-color: rgba(0,0,0,.28); }
  .btn-good { border-color: rgba(0,120,0,.45); }
  .btn-bad { border-color: rgba(160,0,0,.45); }

  .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(0,0,0,.18); font-size: 12px; }
  .muted { opacity: .75; }
  .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

  input[type="text"], input[type="password"] {
    padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(0,0,0,.18);
    background: transparent; width: min(520px, 78vw);
  }

  .onebox { margin-top: 14px; border: 1px solid rgba(0,0,0,.12); border-radius: 16px; padding: 14px; background: rgba(255,255,255,.02); }
  .onebox h3 { margin: 0 0 8px 0; font-size: 18px; line-height: 1.25; }
  .onebox-meta { font-size: 13px; opacity: .88; display:flex; flex-wrap:wrap; gap:8px; margin: 6px 0 10px; }
  .onebox-desc { font-size: 14px; opacity: .92; margin: 0 0 12px; white-space: pre-wrap; }
  .onebox-actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 10px; }
  .onebox-actions .btn { flex: 1 1 140px; padding: 12px 12px; font-size: 15px; }

  .progress { margin-top: 10px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .progress .pill { font-size: 12px; }

  .hidden { display:none !important; }
</style>
</head>
<body>
  <main class="inbox-wrap">
    <div class="inbox-top">
      <div>
        <div class="row">
          <strong>Inbox Review</strong>
          <span id="lockState" class="pill muted">gesperrt</span>
        </div>
        <div class="muted" style="margin-top:4px;">
          Zeigt <code>status=review</code>. Approve setzt <code>√ºbernehmen</code>, Reject setzt <code>verworfen</code>.
        </div>
      </div>

      <!-- === BEGIN BLOCK: INBOX TOP CONTROLS (minimal; settings collapsed) ===
      Zweck:
      - Daily-Review: oben nur 2 Buttons (Settings + Reload)
      - API-URL/Unlock nur in einklappbaren Settings
      Umfang:
      - Ersetzt ausschlie√ülich den bisherigen .inbox-actions Block
      === END BLOCK: INBOX TOP CONTROLS (minimal; settings collapsed) === -->
      <div class="inbox-actions">
        <button id="settingsBtn" class="btn btn-primary" type="button" aria-expanded="false">‚öôÔ∏è</button>
        <button id="reloadBtn" class="btn" type="button">‚Üª</button>
      </div>
    </div>

    <!-- === BEGIN BLOCK: STATUS + SETTINGS PANEL (collapsed) ===
    Zweck:
    - Status kompakt
    - Settings (API-URL + optional Unlock) einklappbar
    Umfang:
    - Ersetzt ausschlie√ülich die statusLine-Zeile
    === END BLOCK: STATUS + SETTINGS PANEL (collapsed) === -->
    <div id="statusLine" class="muted" style="margin-top:10px; font-size:13px;"></div>

    <div id="settingsPanel" class="onebox hidden" style="margin-top:10px;">
      <div class="muted" style="margin-bottom:10px;">
        Settings (nur n√∂tig beim ersten Mal oder wenn du die API-URL √§ndern willst).
      </div>

      <div class="row" style="gap:10px;">
        <input id="apiUrl" type="text" placeholder="Apps Script /exec URL" />
        <button id="saveApiUrl" class="btn btn-primary" type="button">URL speichern</button>
      </div>

      <div class="row" style="margin-top:10px; gap:10px;">
        <button id="unlockBtn" class="btn btn-primary" type="button">Entsperren</button>
        <span class="muted">Tipp: F√ºr Daily-Review brauchst du das nicht ‚Äì Unlock passiert automatisch beim ersten √úbernehmen/Verwerfen.</span>
      </div>
    </div>

<!-- === BEGIN BLOCK: INBOX ONE-BY-ONE CONTAINER ===
Zweck:
- Ersetzt die Listen-Section durch 1-Item-Review Container + Progress
Umfang:
- Ersetzt ausschlie√ülich die Section-Zeile
=== END BLOCK: INBOX ONE-BY-ONE CONTAINER === -->
<section id="one"></section>
<div class="progress">
  <span id="progressLeft" class="pill muted"></span>
  <span id="progressHint" class="pill muted">Shortcuts: O=√ñffnen, A=√úbernehmen, V=Verwerfen</span>
</div>
  </main>

  <script>
      // === BEGIN BLOCK: INBOX REVIEW LOGIC (one-by-one queue + writeback) ===
    // Zweck:
    // - One-by-one Review: zeigt immer nur 1 Item (status=review)
    // - Unlock via Apps Script JSONP (Passwort 1x) -> token in sessionStorage
    // - setStatus via IMG GET (CORS-frei), ben√∂tigt row_number
    // - Nach √úbernehmen/Verwerfen -> n√§chstes Item
    // Umfang:
    // - Ersetzt die gesamte bisherige Logik im <script> Block ab dieser Marker-Zeile
    // === END BLOCK: INBOX REVIEW LOGIC (one-by-one queue + writeback) ===

        // === BEGIN BLOCK: INBOX REVIEW LOGIC (one-by-one queue + writeback) ===
    // Zweck:
    // - One-by-one Review: zeigt immer nur 1 Item (status=review)
    // - Unlock via Apps Script JSONP (Passwort 1x) -> token in sessionStorage
    // - setStatus via IMG GET (CORS-frei), ben√∂tigt row_number
    // - Nach √úbernehmen/Verwerfen -> n√§chstes Item
    // Umfang:
    // - Ersetzt den gesamten JS-Teil ab const FEED_URL bis Ende init()
    // === END BLOCK: INBOX REVIEW LOGIC (one-by-one queue + writeback) ===

       // === BEGIN BLOCK: INBOX REVIEW LOGIC (one-by-one, auto-unlock on approve/reject) ===
    // Zweck:
    // - One-by-one Review: 1 Item sichtbar
    // - Auto-Unlock: beim ersten √úbernehmen/Verwerfen Passwort abfragen -> Token in sessionStorage
    // - Minimaler Screen: Meta komprimiert, Beschreibung standardm√§√üig eingeklappt
    // Umfang:
    // - Ersetzt den gesamten JS-Teil ab const FEED_URL bis Ende init()
    // === END BLOCK: INBOX REVIEW LOGIC (one-by-one, auto-unlock on approve/reject) ===

    const FEED_URL = "/data/inbox.json";
    const LS_API_URL_KEY = "inbox_writeback_api_url";
    const SS_TOKEN_KEY = "inbox_writeback_token";

    const elStatus = document.getElementById("statusLine");
    const elLock = document.getElementById("lockState");
    const elOne = document.getElementById("one");
    const elProgressLeft = document.getElementById("progressLeft");

    const elSettingsBtn = document.getElementById("settingsBtn");
    const elSettingsPanel = document.getElementById("settingsPanel");
    const elApiUrl = document.getElementById("apiUrl");
    const elSaveApiUrl = document.getElementById("saveApiUrl");
    const elUnlockBtn = document.getElementById("unlockBtn");

    let queue = [];
    let current = null;

    document.getElementById("reloadBtn").addEventListener("click", () => loadAndRender());

    elSettingsBtn.addEventListener("click", () => {
      const isOpen = !elSettingsPanel.classList.contains("hidden");
      if (isOpen) {
        elSettingsPanel.classList.add("hidden");
        elSettingsBtn.setAttribute("aria-expanded", "false");
      } else {
        elSettingsPanel.classList.remove("hidden");
        elSettingsBtn.setAttribute("aria-expanded", "true");
      }
    });

    elSaveApiUrl.addEventListener("click", () => {
      const v = (elApiUrl.value || "").trim();
      if (!v) return setStatus("Bitte Apps Script /exec URL eintragen.");
      localStorage.setItem(LS_API_URL_KEY, v);
      setStatus("URL gespeichert.");
    });

    elUnlockBtn.addEventListener("click", async () => {
      const ok = await ensureUnlocked(true);
      if (ok) setStatus("Entsperrt.");
      renderCurrent();
    });

    function getApiUrl() {
      return (localStorage.getItem(LS_API_URL_KEY) || "").trim();
    }

    function getToken() {
      return (sessionStorage.getItem(SS_TOKEN_KEY) || "").trim();
    }

    function isUnlocked() {
      return !!getToken();
    }

    function refreshLockState() {
      if (isUnlocked()) {
        elLock.textContent = "entsperrt";
        elLock.classList.remove("muted");
      } else {
        elLock.textContent = "gesperrt";
        elLock.classList.add("muted");
      }
    }

    function setStatus(msg) {
      elStatus.textContent = msg || "";
    }

    async function loadAndRender() {
      setStatus("Lade inbox.json ‚Ä¶");
      elOne.innerHTML = "";
      queue = [];
      current = null;

      const url = FEED_URL + "?v=" + Date.now();
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) {
        setStatus(`Fehler: inbox.json nicht ladbar (${r.status}).`);
        return;
      }

      const items = await r.json();
      queue = (items || []).filter(it => (String(it.status || "").toLowerCase() === "review"));

      setStatus(`Review: ${queue.length}`);
      showNext();
    }

    function showNext() {
      current = queue.shift() || null;
      renderCurrent();
    }

    function renderCurrent() {
      refreshLockState();

      if (!current) {
        elOne.innerHTML = `
          <div class="onebox">
            <h3>Keine review-items mehr üéâ</h3>
            <div class="muted">‚Üª zum Neuladen.</div>
          </div>
        `;
        elProgressLeft.textContent = "0 √ºbrig";
        return;
      }

      elProgressLeft.textContent = `${queue.length + 1} √ºbrig`;

      const it = current;

      const title = escapeHtml(it.title || "(ohne Titel)");

      const parts = [];
      if (it.date) parts.push(it.date);
      if (it.time) parts.push(it.time);
      if (it.city) parts.push(it.city);
      const metaLine = parts.length ? escapeHtml(parts.join(" ¬∑ ")) : "";

      const locLine = (it.location || "").trim();
      const srcLine = (it.source_name || "").trim();

      const desc = (it.description || "").trim();
      const descShort = desc ? escapeHtml(desc.slice(0, 160) + (desc.length > 160 ? " ‚Ä¶" : "")) : "";

      const openDisabled = !(it.url || it.source_url);

      elOne.innerHTML = `
        <div class="onebox" id="onebox">
          <h3>${title}</h3>

          ${metaLine ? `<div class="muted" style="margin:6px 0 10px; font-size:14px;">${metaLine}</div>` : ""}

          ${locLine ? `<div class="muted" style="margin:-6px 0 10px; font-size:14px;">üìç ${escapeHtml(locLine)}</div>` : ""}

          ${srcLine ? `<div class="muted" style="margin:-6px 0 12px; font-size:13px;">Quelle: ${escapeHtml(srcLine)}</div>` : ""}

          ${desc ? `
            <details style="margin: 0 0 12px;">
              <summary class="muted" style="cursor:pointer; font-size:13px;">Kurztext anzeigen</summary>
              <div class="onebox-desc" style="margin-top:8px;">${escapeHtml(desc)}</div>
            </details>
          ` : ""}

          <div class="onebox-actions">
            <button id="btnOpen" class="btn btn-primary" type="button" ${openDisabled ? "disabled" : ""}>√ñffnen</button>
            <button id="btnOk" class="btn btn-good" type="button">√úbernehmen</button>
            <button id="btnNo" class="btn btn-bad" type="button">Verwerfen</button>
          </div>
        </div>
      `;

      document.getElementById("btnOpen").addEventListener("click", () => openUrl(it));
      document.getElementById("btnOk").addEventListener("click", () => approveReject("√ºbernehmen"));
      document.getElementById("btnNo").addEventListener("click", () => approveReject("verworfen"));
    }

    function openUrl(it) {
      const u = (it.url || it.source_url || "").trim();
      if (!u) {
        alert("Keine URL vorhanden (weder url noch source_url).");
        return;
      }
      window.open(u, "_blank", "noopener,noreferrer");
    }

    async function approveReject(newStatus) {
      if (!current) return;

      // Auto-Unlock beim ersten Klick
      const ok = await ensureUnlocked(false);
      if (!ok) return;

      await setStatusWriteback(current, newStatus);
    }

    async function ensureUnlocked(fromSettings) {
      const api = getApiUrl();
      if (!api) {
        // Settings automatisch √∂ffnen, damit du die URL setzen kannst
        elSettingsPanel.classList.remove("hidden");
        elSettingsBtn.setAttribute("aria-expanded", "true");
        setStatus("Fehlt: Apps Script URL (‚öôÔ∏è √∂ffnen).");
        return false;
      }

      if (isUnlocked()) return true;

      const pw = prompt(fromSettings ? "Passwort zum Entsperren:" : "Passwort (einmal pro Session):");
      if (!pw) return false;

      try {
        const res = await jsonp(api, { action: "unlock", password: pw });
        if (!res || !res.ok || !res.token) {
          setStatus("Unlock fehlgeschlagen.");
          return false;
        }
        sessionStorage.setItem(SS_TOKEN_KEY, res.token);
        refreshLockState();
        setStatus("Entsperrt.");
        return true;
      } catch (e) {
        console.error(e);
        setStatus("Unlock fehlgeschlagen (JSONP/CORS).");
        return false;
      }
    }

    async function setStatusWriteback(it, newStatus) {
      const api = getApiUrl();
      const token = getToken();

      if (!it.row_number) {
        alert("Fehlt: row_number im Feed. Bitte Deploy pr√ºfen.");
        return;
      }

      const btnOk = document.getElementById("btnOk");
      const btnNo = document.getElementById("btnNo");
      const btnOpen = document.getElementById("btnOpen");
      if (btnOk) btnOk.disabled = true;
      if (btnNo) btnNo.disabled = true;
      if (btnOpen) btnOpen.disabled = true;

      const img = new Image();
      const qs = new URLSearchParams({
        action: "setStatus",
        token,
        row_number: String(it.row_number),
        status: String(newStatus)
      });

      img.onload = () => {
        setStatus(`OK ‚Üí ${newStatus}`);
        showNext();
      };
      img.onerror = () => {
        setStatus(`Fehler bei ${newStatus} (Token abgelaufen?)`);
        renderCurrent();
      };

      img.src = api.replace(/\/exec.*$/, "/exec") + "?" + qs.toString() + "&t=" + Date.now();
    }

    function escapeHtml(s) {
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function jsonp(apiUrl, params) {
      return new Promise((resolve, reject) => {
        const cbName = "__inbox_cb_" + Math.random().toString(16).slice(2);
        const qs = new URLSearchParams(params || {});
        qs.set("callback", cbName);

        const src = apiUrl.replace(/\/exec.*$/, "/exec") + "?" + qs.toString() + "&t=" + Date.now();
        const script = document.createElement("script");

        window[cbName] = (data) => {
          cleanup();
          resolve(data);
        };

        script.onerror = () => {
          cleanup();
          reject(new Error("jsonp_load_failed"));
        };

        function cleanup() {
          try { delete window[cbName]; } catch (_) { window[cbName] = undefined; }
          if (script.parentNode) script.parentNode.removeChild(script);
        }

        script.src = src;
        document.body.appendChild(script);
      });
    }

    (function init() {
      const saved = localStorage.getItem(LS_API_URL_KEY);
      if (saved) elApiUrl.value = saved;
      refreshLockState();
      loadAndRender().catch(err => {
        console.error(err);
        setStatus("Fehler beim Laden/Rendern (siehe Console).");
      });
    })();
  </script>
</body>
</html>
