<!-- === BEGIN BLOCK: INBOX REVIEW PAGE (standalone, writeback-ready) ===
Zweck:
- Private Inbox-Review-Seite (nicht verlinkt)
- L√§dt /data/inbox.json, filtert status=review
- √ñffnen (url/source_url) + √úbernehmen/Verwerfen per Apps-Script-Writeback
Umfang:
- Komplettes inbox/index.html inkl. Inline-JS
=== END BLOCK: INBOX REVIEW PAGE (standalone, writeback-ready) === -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inbox Review</title>
  <link rel="stylesheet" href="../css/style.css" />
<style>
  /* === BEGIN BLOCK: INBOX ONE-BY-ONE UI (mobile-first, minimal) ===
     Zweck:
     - One-by-one Review (nur 1 Item sichtbar)
     - Buttons gro√ü, klare Struktur, weniger Text
     Umfang:
     - Ersetzt ausschlie√ülich den kompletten <style> Block
  === END BLOCK: INBOX ONE-BY-ONE UI (mobile-first, minimal) === */

  .inbox-wrap { max-width: 720px; margin: 0 auto; padding: 14px; }
  .inbox-top { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
  .inbox-actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

  .btn { padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(0,0,0,.18); background: transparent; cursor: pointer; }
  .btn:disabled { opacity: .45; cursor: not-allowed; }
  .btn-primary { border-color: rgba(0,0,0,.28); }
  .btn-good { border-color: rgba(0,120,0,.45); }
  .btn-bad { border-color: rgba(160,0,0,.45); }

  .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(0,0,0,.18); font-size: 12px; }
  .muted { opacity: .75; }
  .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

  input[type="text"], input[type="password"] {
    padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(0,0,0,.18);
    background: transparent; width: min(520px, 78vw);
  }

  .onebox { margin-top: 14px; border: 1px solid rgba(0,0,0,.12); border-radius: 16px; padding: 14px; background: rgba(255,255,255,.02); }
  .onebox h3 { margin: 0 0 8px 0; font-size: 18px; line-height: 1.25; }
  .onebox-meta { font-size: 13px; opacity: .88; display:flex; flex-wrap:wrap; gap:8px; margin: 6px 0 10px; }
  .onebox-desc { font-size: 14px; opacity: .92; margin: 0 0 12px; white-space: pre-wrap; }
  .onebox-actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 10px; }
  .onebox-actions .btn { flex: 1 1 140px; padding: 12px 12px; font-size: 15px; }

  .progress { margin-top: 10px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .progress .pill { font-size: 12px; }

  .hidden { display:none !important; }
</style>
</head>
<body>
  <main class="inbox-wrap">
    <div class="inbox-top">
      <div>
        <div class="row">
          <strong>Inbox Review</strong>
          <span id="lockState" class="pill muted">gesperrt</span>
        </div>
       <!-- FINAL REVIEW UI: Header minimal -->
<div class="muted" style="margin-top:4px;">
  Review-Modus
</div>
      </div>

      <!-- === BEGIN BLOCK: INBOX TOP CONTROLS (minimal; settings collapsed) ===
      Zweck:
      - Daily-Review: oben nur 2 Buttons (Settings + Reload)
      - API-URL/Unlock nur in einklappbaren Settings
      Umfang:
      - Ersetzt ausschlie√ülich den bisherigen .inbox-actions Block
      === END BLOCK: INBOX TOP CONTROLS (minimal; settings collapsed) === -->
      <!-- === BEGIN BLOCK: INBOX TOP CONTROLS (ultra-minimal) ===
      Zweck:
      - Daily Review: nur Reload
      - Keine Settings/UI f√ºr API-URL (API ist fest im Script verdrahtet)
      Umfang:
      - Ersetzt ausschlie√ülich den bisherigen .inbox-actions Block
      === END BLOCK: INBOX TOP CONTROLS (ultra-minimal) === -->
      <div class="inbox-actions">
        <button id="reloadBtn" class="btn" type="button">‚Üª</button>
      </div>
    </div>

    <!-- === BEGIN BLOCK: STATUS (minimal; no settings UI) ===
    Zweck:
    - Nur Statuszeile, keine Settings/URL/Unlock UI mehr (Storage wird nicht genutzt)
    Umfang:
    - Ersetzt den gesamten STATUS+SETTINGS Bereich
    === END BLOCK: STATUS (minimal; no settings UI) === -->
    <div id="statusLine" class="muted" style="margin-top:10px; font-size:13px;"></div>

<!-- === BEGIN BLOCK: INBOX ONE-BY-ONE CONTAINER ===
Zweck:
- Ersetzt die Listen-Section durch 1-Item-Review Container + Progress
Umfang:
- Ersetzt ausschlie√ülich die Section-Zeile
=== END BLOCK: INBOX ONE-BY-ONE CONTAINER === -->
<section id="one"></section>
<div class="progress">
  <span id="progressLeft" class="pill muted"></span>
 <!-- entfernt: shortcuts hint -->
</div>
  </main>

  <script>
      // === BEGIN BLOCK: INBOX REVIEW LOGIC (one-by-one queue + writeback) ===
    // Zweck:
    // - One-by-one Review: zeigt immer nur 1 Item (status=review)
    // - Unlock via Apps Script JSONP (Passwort 1x) -> token in sessionStorage
    // - setStatus via IMG GET (CORS-frei), ben√∂tigt row_number
    // - Nach √úbernehmen/Verwerfen -> n√§chstes Item
    // Umfang:
    // - Ersetzt die gesamte bisherige Logik im <script> Block ab dieser Marker-Zeile
    // === END BLOCK: INBOX REVIEW LOGIC (one-by-one queue + writeback) ===

        // === BEGIN BLOCK: INBOX REVIEW LOGIC (one-by-one queue + writeback) ===
    // Zweck:
    // - One-by-one Review: zeigt immer nur 1 Item (status=review)
    // - Unlock via Apps Script JSONP (Passwort 1x) -> token in sessionStorage
    // - setStatus via IMG GET (CORS-frei), ben√∂tigt row_number
    // - Nach √úbernehmen/Verwerfen -> n√§chstes Item
    // Umfang:
    // - Ersetzt den gesamten JS-Teil ab const FEED_URL bis Ende init()
    // === END BLOCK: INBOX REVIEW LOGIC (one-by-one queue + writeback) ===

       // === BEGIN BLOCK: INBOX REVIEW LOGIC (one-by-one, auto-unlock on approve/reject) ===
    // Zweck:
    // - One-by-one Review: 1 Item sichtbar
    // - Auto-Unlock: beim ersten √úbernehmen/Verwerfen Passwort abfragen -> Token in sessionStorage
    // - Minimaler Screen: Meta komprimiert, Beschreibung standardm√§√üig eingeklappt
    // Umfang:
    // - Ersetzt den gesamten JS-Teil ab const FEED_URL bis Ende init()
    // === END BLOCK: INBOX REVIEW LOGIC (one-by-one, auto-unlock on approve/reject) ===

       // === BEGIN BLOCK: INBOX REVIEW LOGIC (storage-free, fixed API URL, in-memory token) ===
    // Zweck:
    // - One-by-one Review: 1 Item sichtbar (status=review)
    // - Kein localStorage/sessionStorage (Tracking Prevention kompatibel)
    // - API_URL ist fest verdrahtet
    // - Auto-Unlock beim ersten √úbernehmen/Verwerfen (Passwort-Prompt)
    // - Token nur im RAM (gilt solange Seite offen ist)
    // Umfang:
    // - Ersetzt den gesamten JS-Teil ab const FEED_URL bis Ende init()
    // === END BLOCK: INBOX REVIEW LOGIC (storage-free, fixed API URL, in-memory token) ===

    const FEED_URL = "/data/inbox.json";
    const API_URL = "https://script.google.com/macros/s/AKfycbwSEtz9anZOfRLcZkJqH3V5_O-vT9nBqmU1Ig-UooXwl6tkbu2Vd-MGWCgX1900-ZcN/exec";

    const elStatus = document.getElementById("statusLine");
    const elLock = document.getElementById("lockState");
    const elOne = document.getElementById("one");
    const elProgressLeft = document.getElementById("progressLeft");

    let queue = [];
    let current = null;

    // Token nur im RAM
    let sessionToken = "";

    document.getElementById("reloadBtn").addEventListener("click", () => loadAndRender());

    function isUnlocked() {
      return !!sessionToken;
    }

    function refreshLockState() {
      if (isUnlocked()) {
        elLock.textContent = "entsperrt";
        elLock.classList.remove("muted");
      } else {
        elLock.textContent = "gesperrt";
        elLock.classList.add("muted");
      }
    }

    function setStatus(msg) {
      elStatus.textContent = msg || "";
    }

    async function loadAndRender() {
      setStatus("Lade inbox.json ‚Ä¶");
      elOne.innerHTML = "";
      queue = [];
      current = null;

      const url = FEED_URL + "?v=" + Date.now();
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) {
        setStatus(`Fehler: inbox.json nicht ladbar (${r.status}).`);
        return;
      }

      const items = await r.json();
      queue = (items || []).filter(it => (String(it.status || "").toLowerCase() === "review"));

      setStatus(`Review: ${queue.length}`);
      showNext();
    }

    function showNext() {
      current = queue.shift() || null;
      renderCurrent();
    }

    function renderCurrent() {
      refreshLockState();

      if (!current) {
        elOne.innerHTML = `
          <div class="onebox">
            <h3>Keine review-items mehr üéâ</h3>
            <div class="muted">‚Üª zum Neuladen.</div>
          </div>
        `;
        elProgressLeft.textContent = "0 √ºbrig";
        return;
      }

      elProgressLeft.textContent = `${queue.length + 1} √ºbrig`;

      const it = current;

      const title = escapeHtml(it.title || "(ohne Titel)");

     let metaLine = "";

if (it.date || it.time) {

  metaLine += "üìÖ ";

  if (it.date) metaLine += escapeHtml(it.date);

  if (it.time) metaLine += "  " + escapeHtml(it.time);
}

if (it.city) {

  metaLine += "<br>üìç " + escapeHtml(it.city);
}

      const locLine = (it.location || "").trim();
      const srcLine = (it.source_name || "").trim();

      const desc = (it.description || "").trim();
      const openDisabled = !(it.url || it.source_url);

      elOne.innerHTML = `
        <div class="onebox" id="onebox">
          <h3>${title}</h3>

          ${metaLine ? `<div class="muted" style="margin:6px 0 10px; font-size:14px;">${metaLine}</div>` : ""}

          ${locLine ? `<div class="muted" style="margin:-6px 0 10px; font-size:14px;">üìç ${escapeHtml(locLine)}</div>` : ""}

         ${srcLine ? `<div class="muted" style="margin:6px 0 12px; font-size:13px;">
Quelle:<br><strong>${escapeHtml(srcLine)}</strong>
</div>` : ""}

${desc ? `
  <div class="onebox-desc">
    ${escapeHtml(desc)}
  </div>
` : ""}

          <div class="onebox-actions">
            <button id="btnOpen" class="btn btn-primary" type="button" ${openDisabled ? "disabled" : ""}>√ñffnen</button>
            <button id="btnOk" class="btn btn-good" type="button">√úbernehmen</button>
            <button id="btnNo" class="btn btn-bad" type="button">Verwerfen</button>
          </div>

          ${isUnlocked() ? `` : `<div class="muted" style="margin-top:10px;">Beim ersten √úbernehmen/Verwerfen wird einmal nach Passwort gefragt.</div>`}
        </div>
      `;

      document.getElementById("btnOpen").addEventListener("click", () => openUrl(it));
      document.getElementById("btnOk").addEventListener("click", () => approveReject("√ºbernehmen"));
      document.getElementById("btnNo").addEventListener("click", () => approveReject("verworfen"));
    }

    function openUrl(it) {
      const u = (it.url || it.source_url || "").trim();
      if (!u) {
        alert("Keine URL vorhanden (weder url noch source_url).");
        return;
      }
      window.open(u, "_blank", "noopener,noreferrer");
    }

    async function approveReject(newStatus) {
      if (!current) return;

      const ok = await ensureUnlocked();
      if (!ok) return;

      setStatusWriteback(current, newStatus);
    }

    async function ensureUnlocked() {
      if (isUnlocked()) return true;

      const pw = prompt("Passwort (einmal pro Session):");
      if (!pw) return false;

      try {
        const res = await jsonp(API_URL, { action: "unlock", password: pw });
        if (!res || !res.ok || !res.token) {
          setStatus("Unlock fehlgeschlagen.");
          return false;
        }
        sessionToken = String(res.token || "");
        refreshLockState();
        setStatus("Entsperrt.");
        return true;
      } catch (e) {
        console.error(e);
        setStatus("Unlock fehlgeschlagen (JSONP).");
        return false;
      }
    }

    function setStatusWriteback(it, newStatus) {
      if (!it.row_number) {
        alert("Fehlt: row_number im Feed. Bitte Deploy pr√ºfen.");
        return;
      }

      const btnOk = document.getElementById("btnOk");
      const btnNo = document.getElementById("btnNo");
      const btnOpen = document.getElementById("btnOpen");
      if (btnOk) btnOk.disabled = true;
      if (btnNo) btnNo.disabled = true;
      if (btnOpen) btnOpen.disabled = true;

      const img = new Image();
      const qs = new URLSearchParams({
        action: "setStatus",
        token: sessionToken,
        row_number: String(it.row_number),
        status: String(newStatus)
      });

      img.onload = () => {
        setStatus(`OK ‚Üí ${newStatus}`);
        showNext();
      };
      img.onerror = () => {
        setStatus(`Fehler bei ${newStatus} (Token abgelaufen?)`);
        // Token ggf. ung√ºltig -> wieder sperren
        sessionToken = "";
        renderCurrent();
      };

      img.src = API_URL.replace(/\/exec.*$/, "/exec") + "?" + qs.toString() + "&t=" + Date.now();
    }

    function escapeHtml(s) {
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function jsonp(apiUrl, params) {
      return new Promise((resolve, reject) => {
        const cbName = "__inbox_cb_" + Math.random().toString(16).slice(2);
        const qs = new URLSearchParams(params || {});
        qs.set("callback", cbName);

        const src = apiUrl.replace(/\/exec.*$/, "/exec") + "?" + qs.toString() + "&t=" + Date.now();
        const script = document.createElement("script");

        window[cbName] = (data) => {
          cleanup();
          resolve(data);
        };

        script.onerror = () => {
          cleanup();
          reject(new Error("jsonp_load_failed"));
        };

        function cleanup() {
          try { delete window[cbName]; } catch (_) { window[cbName] = undefined; }
          if (script.parentNode) script.parentNode.removeChild(script);
        }

        script.src = src;
        document.body.appendChild(script);
      });
    }

    (function init() {
      refreshLockState();
      loadAndRender().catch(err => {
        console.error(err);
        setStatus("Fehler beim Laden/Rendern (siehe Console).");
      });
    })();
  </script>
</body>
</html>
