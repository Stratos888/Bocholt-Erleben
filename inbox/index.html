<!-- === BEGIN BLOCK: INBOX REVIEW PAGE (standalone, writeback-ready) ===
Zweck:
- Private Inbox-Review-Seite (nicht verlinkt)
- L√§dt /data/inbox.json, filtert status=review
- √ñffnen (url/source_url) + √úbernehmen/Verwerfen per Apps-Script-Writeback
Umfang:
- Komplettes inbox/index.html inkl. Inline-JS
=== END BLOCK: INBOX REVIEW PAGE (standalone, writeback-ready) === -->
<!-- === BEGIN BLOCK: INBOX REVIEW PAGE (FINAL UI, storage-free) ===
Zweck:
- Finaler Daily-Review Screen: 1 Event gleichzeitig, maximal √ºbersichtlich.
- Immer sichtbarer extrahierter Text (description).
- Auto-Unlock beim ersten √úbernehmen/Verwerfen (Passwort-Prompt).
- Kein localStorage/sessionStorage (Tracking-Prevention kompatibel).
- API_URL fest verdrahtet.
Umfang:
- Komplette inbox/index.html (konsolidiert).
=== END BLOCK: INBOX REVIEW PAGE (FINAL UI, storage-free) === -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inbox Review</title>
  <link rel="stylesheet" href="../css/style.css" />
  <style>
    /* === BEGIN BLOCK: FINAL REVIEW UI CSS (minimal, readable) ===
       Zweck:
       - Max. Lesbarkeit & klare Hierarchie f√ºr schnelles Ja/Nein.
       - Keine Debug-/Setup-UI.
       Umfang:
       - Nur Styles f√ºr diese Seite.
    === END BLOCK: FINAL REVIEW UI CSS (minimal, readable) === */

    .wrap { max-width: 720px; margin: 0 auto; padding: 14px; }
    .top { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .brand { display:flex; align-items:baseline; gap:10px; }
    .title { font-weight: 700; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(0,0,0,.18); font-size: 12px; }
    .muted { opacity: .75; }
    .btn { padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(0,0,0,.18); background: transparent; cursor: pointer; }
    .btn:disabled { opacity: .45; cursor: not-allowed; }
    .btn-good { border-color: rgba(0,120,0,.45); }
    .btn-bad { border-color: rgba(160,0,0,.45); }

    .status { margin-top: 10px; font-size: 13px; }
    .card { margin-top: 12px; border: 1px solid rgba(0,0,0,.12); border-radius: 16px; padding: 14px; background: rgba(255,255,255,.02); }
    .card h1 { margin: 0 0 10px 0; font-size: 18px; line-height: 1.25; }

    .meta { font-size: 14px; line-height: 1.35; margin: 0 0 10px 0; }
    .meta .line { margin: 3px 0; }

    .descTitle { margin: 10px 0 6px; font-size: 12px; letter-spacing: .02em; text-transform: uppercase; opacity: .8; }
    .desc { white-space: pre-wrap; font-size: 14px; line-height: 1.4; margin: 0 0 12px 0; }

    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .actions .btn { flex: 1 1 160px; padding: 12px; font-size: 15px; }
    .sourceBtn { flex: 1 1 100%; }

    .footer { margin-top: 10px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  </style>
</head>

<body>
  <main class="wrap">
    <div class="top">
      <div class="brand">
        <div class="title">Inbox Review</div>
        <span id="lockState" class="pill muted">gesperrt</span>
      </div>
      <button id="reloadBtn" class="btn" type="button" aria-label="Reload">‚Üª</button>
    </div>

    <div id="statusLine" class="status muted"></div>

    <section id="one"></section>

    <div class="footer">
      <span id="progressLeft" class="pill muted"></span>
      <span id="progressRight" class="pill muted"></span>
    </div>
  </main>

  <script>
    // === BEGIN BLOCK: FINAL REVIEW LOGIC (storage-free, fixed API, auto-unlock) ===
    // Zweck:
    // - L√§dt /data/inbox.json, filtert status=review
    // - Zeigt immer genau 1 Event
    // - description immer sichtbar
    // - Auto-Unlock beim ersten Approve/Reject (Passwort-Prompt)
    // - Token nur im RAM (solange Tab offen)
    // Umfang:
    // - Vollst√§ndige Logik f√ºr diese Seite (konsolidiert)
    // === END BLOCK: FINAL REVIEW LOGIC (storage-free, fixed API, auto-unlock) ===

    const FEED_URL = "/data/inbox.json";
    const API_URL  = "https://script.google.com/macros/s/AKfycbwSEtz9anZOfRLcZkJqH3V5_O-vT9nBqmU1Ig-UooXwl6tkbu2Vd-MGWCgX1900-ZcN/exec";

    const elOne = document.getElementById("one");
    const elStatus = document.getElementById("statusLine");
    const elLock = document.getElementById("lockState");
    const elLeft = document.getElementById("progressLeft");
    const elRight = document.getElementById("progressRight");

    let queue = [];
    let current = null;

    // Token nur im RAM (keine Storage APIs)
    let sessionToken = "";

    document.getElementById("reloadBtn").addEventListener("click", () => loadAndShow());

    function setStatus(msg) {
      elStatus.textContent = msg || "";
    }

    function isUnlocked() {
      return !!sessionToken;
    }

    function refreshLock() {
      if (isUnlocked()) {
        elLock.textContent = "entsperrt";
        elLock.classList.remove("muted");
      } else {
        elLock.textContent = "gesperrt";
        elLock.classList.add("muted");
      }
    }

    async function loadAndShow() {
      setStatus("Lade ‚Ä¶");
      elOne.innerHTML = "";
      queue = [];
      current = null;

      const r = await fetch(FEED_URL + "?v=" + Date.now(), { cache: "no-store" });
      if (!r.ok) {
        setStatus(`Fehler: inbox.json (${r.status})`);
        elLeft.textContent = "";
        elRight.textContent = "";
        return;
      }

      const items = await r.json();
      queue = (items || []).filter(it => String(it.status || "").toLowerCase() === "review");

      refreshLock();
      setStatus(queue.length ? "" : "Keine review-items.");

      showNext(items.length);
    }

    function showNext(totalCount) {
      current = queue.shift() || null;
      renderCurrent(totalCount);
    }

    function renderCurrent(totalCount) {
      refreshLock();

      const remaining = queue.length + (current ? 1 : 0);
      elLeft.textContent = remaining ? `${remaining} √ºbrig` : `0 √ºbrig`;
      elRight.textContent = totalCount ? `Inbox: ${totalCount}` : "";

      if (!current) {
        elOne.innerHTML = `
          <div class="card">
            <h1>Fertig üéâ</h1>
            <div class="muted">‚Üª zum Neuladen.</div>
          </div>
        `;
        return;
      }

      const it = current;

      // Meta: klar & schnell scanbar
      const dateTime = [
        (it.date || "").trim(),
        (it.time || "").trim()
      ].filter(Boolean).join(" ¬∑ ");

      const placeLine = [
        (it.city || "").trim(),
        (it.location || "").trim()
      ].filter(Boolean).join(" ‚Äî ");

      const sourceLine = (it.source_name || "").trim();
      const desc = (it.description || "").trim();

      const urlToOpen = (it.url || it.source_url || "").trim();
      const openDisabled = !urlToOpen;

      elOne.innerHTML = `
        <article class="card">
          <h1>${escapeHtml(it.title || "(ohne Titel)")}</h1>

          <div class="meta">
            ${dateTime ? `<div class="line">üìÖ ${escapeHtml(dateTime)}</div>` : ``}
            ${placeLine ? `<div class="line">üìç ${escapeHtml(placeLine)}</div>` : ``}
            ${sourceLine ? `<div class="line muted">Quelle: <strong>${escapeHtml(sourceLine)}</strong></div>` : ``}
          </div>

          <div class="descTitle">Extrahierter Text</div>
          <p class="desc">${escapeHtml(desc || "(kein Text vorhanden)")}</p>

          <div class="actions">
            <button id="btnOpen" class="btn sourceBtn" type="button" ${openDisabled ? "disabled" : ""}>Quelle √∂ffnen</button>
            <button id="btnNo" class="btn btn-bad" type="button">‚ùå Verwerfen</button>
            <button id="btnOk" class="btn btn-good" type="button">‚úÖ √úbernehmen</button>
          </div>

          ${isUnlocked() ? `` : `<div class="muted" style="margin-top:10px;">Beim ersten Klick auf √úbernehmen/Verwerfen wird einmal nach Passwort gefragt.</div>`}
        </article>
      `;

      document.getElementById("btnOpen").addEventListener("click", () => {
        if (!urlToOpen) return;
        window.open(urlToOpen, "_blank", "noopener,noreferrer");
      });

      document.getElementById("btnOk").addEventListener("click", () => approveReject("√ºbernehmen"));
      document.getElementById("btnNo").addEventListener("click", () => approveReject("verworfen"));
    }

    async function approveReject(status) {
      if (!current) return;

      const ok = await ensureUnlocked();
      if (!ok) return;

      await writeStatus(current, status);
    }

    async function ensureUnlocked() {
      if (isUnlocked()) return true;

      const pw = prompt("Passwort (einmal pro Session):");
      if (!pw) return false;

      try {
        const res = await jsonp(API_URL, { action: "unlock", password: pw });
        if (!res || !res.ok || !res.token) {
          setStatus("Unlock fehlgeschlagen.");
          return false;
        }
        sessionToken = String(res.token || "");
        refreshLock();
        setStatus("");
        return true;
      } catch (e) {
        console.error(e);
        setStatus("Unlock fehlgeschlagen.");
        return false;
      }
    }

function writeStatus(it, newStatus) {
  return new Promise(async (resolve) => {
    if (!it.row_number) {
      alert("Fehlt: row_number im Feed. Bitte Deploy pr√ºfen.");
      return resolve();
    }

    // Buttons sperren
    const btnOk = document.getElementById("btnOk");
    const btnNo = document.getElementById("btnNo");
    const btnOpen = document.getElementById("btnOpen");
    if (btnOk) btnOk.disabled = true;
    if (btnNo) btnNo.disabled = true;
    if (btnOpen) btnOpen.disabled = true;

    try {
      const res = await jsonp(API_URL, {
        action: "setStatus",
        token: sessionToken,
        row_number: String(it.row_number),
        status: String(newStatus)
      });

      if (res && res.ok) {
        setStatus(newStatus === "√ºbernehmen" ? "√úbernommen." : "Verworfen.");
        showNext();
        return resolve();
      }

      // Server hat geantwortet, aber ok=false (z. B. token invalid/expired)
      sessionToken = "";
      refreshLock();
      setStatus("Fehler beim Schreiben (Token ung√ºltig) ‚Äì bitte erneut klicken.");
      renderCurrent();
      return resolve();

    } catch (e) {
      console.error(e);
      // Netzwerk/JSONP Fehler
      sessionToken = "";
      refreshLock();
      setStatus("Fehler beim Schreiben (Netz/JSONP) ‚Äì bitte erneut klicken.");
      renderCurrent();
      return resolve();
    }
  });
}

    function escapeHtml(s) {
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // JSONP, damit Unlock robust ohne CORS-Header funktioniert
    function jsonp(apiUrl, params) {
      return new Promise((resolve, reject) => {
        const cbName = "__inbox_cb_" + Math.random().toString(16).slice(2);
        const qs = new URLSearchParams(params || {});
        qs.set("callback", cbName);

        const src = apiUrl.replace(/\/exec.*$/, "/exec") + "?" + qs.toString() + "&t=" + Date.now();
        const script = document.createElement("script");

        window[cbName] = (data) => {
          cleanup();
          resolve(data);
        };

        script.onerror = () => {
          cleanup();
          reject(new Error("jsonp_load_failed"));
        };

        function cleanup() {
          try { delete window[cbName]; } catch (_) { window[cbName] = undefined; }
          if (script.parentNode) script.parentNode.removeChild(script);
        }

        script.src = src;
        document.body.appendChild(script);
      });
    }

    // Init
    (function init() {
      refreshLock();
      loadAndShow().catch(err => {
        console.error(err);
        setStatus("Fehler beim Laden.");
      });
    })();
  </script>
</body>
</html>
